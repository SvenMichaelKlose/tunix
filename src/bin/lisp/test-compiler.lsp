(dolist (i '("let" "mapcar" "mapcan" "do" "dolist" "aif"
             "with" "with-global" "prog1" "progn" "push"
             "group" "!=" "when" "make-queue" "with-queue"
             "queue-list" "enqueue"))
  (or (load (symbol (nconc (symbol-name i)
                           (symbol-name ".lsp"))))
      (error i)))

(message "Testing CMACROEXPAND...")
(load "cmacros.lsp")
(print (cmacroexpand '(and a b c)))
(print (cmacroexpand '(or a b c)))
(print (cmacroexpand '(? a b c)))

(message "Testing ARGEXPAND...")
(load "argexpand.lsp")
(and (argexpand nil nil)
     (error))
(or (equal (argexpand '(a b c) '(1 2 3))
           '((a 1) (b 2) (c 3)))
    (error))
(or (equal (argexpand '(a b . c) '(1 2 3))
           '((a 1) (b 2) (c (3))))
    (error))
(or (equal (argexpand '(a b . c) '(1 2 3 4))
           '((a 1) (b 2) (c (3 4))))
    (error))

(message "Testing FOLD-BLOCKS...")
(load "fold-block.lsp")
(!= (cmacroexpand (cdr macroexpand))
  (!= (@ fold-block !)
    (print 'unfolded)
    (@ print !)))

(message "Testing INLINE-FNS...")
(load "inline-fn.lsp")
(print (inline-fn '((nil (print "6502 inside")))))
(print (inline-fn '((x (print "6502 inside")) 1 2)))
(print (inline-fn '(((a b) (print "6502 inside")) 1 2)))

(message "Testing EXEXPAND...")
(load "exexpand.lsp")
(print (exexpand (print '(a b c d))))
(print (exexpand (print '(a (b c d)))))
(print (exexpand (print '(a (b (c d))))))

(message "Testing COMPILE...")
(load "dotimes.lsp")
(fn compile (x)
  (print 'input)
  (print x)
  (= x (macroexpand x))
  (print 'macroexpand)
  (print x)
  (= x (cmacroexpand x))
  (print 'cmacroexpand)
  (print x)
  (= x (@ inline-fn x))
  (print 'inline-fn)
  (print x)
  (= x (mapcan fold-block x))
  (print 'fold-block)
  (print x)
  (= x (mapcan exexpand x))
  (print 'exexpand)
  (print x))

(compile '((dotimes (i 10) (print i))))
